{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/beeho/Desktop/painelFinanceiro/gestor-financeiro-beehouse/app/lib/supabase.js"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseKey)"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM;AAEC,MAAM,WAAW,IAAA,yMAAY,EAAC,aAAa"}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/beeho/Desktop/painelFinanceiro/gestor-financeiro-beehouse/app/api/cron/route.js"],"sourcesContent":["import { supabase } from '../../lib/supabase';\r\nimport { addMonths, setDate, format, lastDayOfMonth } from 'date-fns';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\nexport async function GET(request) {\r\n  const authHeader = request.headers.get('authorization');\r\n  if (process.env.CRON_SECRET && authHeader !== `Bearer ${process.env.CRON_SECRET}`) {\r\n    // return new Response('Unauthorized', { status: 401 });\r\n  }\r\n\r\n  try {\r\n    await gerarRecorrencias();\r\n    const notificationResult = await verificarVencimentos();\r\n    return Response.json({ success: true, notification: notificationResult });\r\n  } catch (error) {\r\n    return Response.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\nasync function gerarRecorrencias() {\r\n    const { data: recurring } = await supabase.from('recurring_expenses').select('*').eq('active', true);\r\n    if (!recurring || recurring.length === 0) return;\r\n\r\n    const hoje = new Date();\r\n    const mesesParaGerar = [hoje, addMonths(hoje, 1)]; \r\n    const novosLancamentos = [];\r\n\r\n    // Busca transa√ß√µes j√° lan√ßadas para n√£o duplicar\r\n    const { data: transacoesExistentes } = await supabase.from('transactions').select('*');\r\n\r\n    for (const mesRef of mesesParaGerar) {\r\n        for (const item of recurring) {\r\n            let dataVencimento = setDate(mesRef, item.day_of_month);\r\n            \r\n            // Corrige se o dia n√£o existe no m√™s (ex: 31 de Fev)\r\n            if (dataVencimento.getMonth() !== mesRef.getMonth()) {\r\n                dataVencimento = lastDayOfMonth(mesRef);\r\n            }\r\n\r\n            const dataString = format(dataVencimento, 'yyyy-MM-dd');\r\n\r\n            // Verifica duplicidade (agora usando o ID da regra se dispon√≠vel, ou fallback para l√≥gica antiga)\r\n            const jaExiste = transacoesExistentes.some(t => \r\n                (t.recurring_rule_id === item.id && t.due_date === dataString) || \r\n                (t.supplier_id === item.supplier_id && parseFloat(t.amount) === parseFloat(item.amount) && t.due_date === dataString)\r\n            );\r\n\r\n            if (!jaExiste) {\r\n                novosLancamentos.push({\r\n                    description: item.description,\r\n                    amount: item.amount,\r\n                    due_date: dataString,\r\n                    supplier_id: item.supplier_id,\r\n                    category_id: item.category_id,\r\n                    status: dataString < new Date().toISOString().split('T')[0] ? 'Vencido' : 'Aberto',\r\n                    recurring_rule_id: item.id // <--- O SEGREDO EST√Å AQUI\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    if (novosLancamentos.length > 0) {\r\n        await supabase.from('transactions').insert(novosLancamentos);\r\n    }\r\n}\r\n\r\n\r\n// --- FUN√á√ÉO 2: NOTIFICA√á√ïES (Sua l√≥gica original preservada e encapsulada) ---\r\nasync function verificarVencimentos() {\r\n    const hoje = new Date().toISOString().split('T')[0]; \r\n    const futuro = new Date();\r\n    futuro.setDate(futuro.getDate() + 2);\r\n    const dataFuturo = futuro.toISOString().split('T')[0];\r\n\r\n    const { data: contasHoje } = await supabase.from('transactions').select('*, suppliers(name)').eq('due_date', hoje).neq('status', 'Pago');\r\n    const { data: contasFuturo } = await supabase.from('transactions').select('*, suppliers(name)').eq('due_date', dataFuturo).neq('status', 'Pago');\r\n\r\n    if ((contasHoje && contasHoje.length > 0) || (contasFuturo && contasFuturo.length > 0)) {\r\n        await enviarParaBitrix(contasHoje || [], contasFuturo || []);\r\n        return 'Notifica√ß√£o enviada';\r\n    }\r\n    return 'Nada para notificar';\r\n}\r\n\r\nasync function enviarParaBitrix(hoje, futuro) {\r\n    const totalHoje = hoje.reduce((sum, i) => sum + i.amount, 0);\r\n    const totalFuturo = futuro.reduce((sum, i) => sum + i.amount, 0);\r\n    const quebra = \"\\n\";\r\n\r\n    let msg = \"üí∞ [B]FINANCEIRO BEEHOUSE[/B]\" + quebra;\r\n    msg += \"---------------------------------\" + quebra;\r\n\r\n    if(hoje.length > 0) {\r\n        msg += `üî¥ [B][COLOR=#ff0000]VENCE HOJE (${hoje.length})[/COLOR][/B] - Total: R$ ${totalHoje.toFixed(2)}` + quebra;\r\n        hoje.forEach(t => msg += `‚ñ™ ${t.description} - R$ ${t.amount}` + quebra);\r\n        msg += quebra;\r\n    }\r\n\r\n    if(futuro.length > 0) {\r\n        msg += `‚ö†Ô∏è [B]EM 2 DIAS (${futuro.length})[/B] - Total: R$ ${totalFuturo.toFixed(2)}` + quebra;\r\n        futuro.forEach(t => msg += `‚ñ™ ${t.description} - R$ ${t.amount}` + quebra);\r\n    }\r\n\r\n    msg += \"---------------------------------\" + quebra;\r\n    msg += `[URL=https://${process.env.VERCEL_URL}]‚û°Ô∏è ABRIR GESTOR[/URL]`;\r\n\r\n    const webhookUrl = process.env.BITRIX_WEBHOOK_URL + \"im.message.add\";\r\n    \r\n    await fetch(webhookUrl, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n            \"DIALOG_ID\": process.env.ID_COLABORADOR_FINANCEIRO,\r\n            \"MESSAGE\": msg,\r\n            \"SYSTEM\": \"Y\"\r\n        })\r\n    });\r\n}"],"names":[],"mappings":"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"}}]
}