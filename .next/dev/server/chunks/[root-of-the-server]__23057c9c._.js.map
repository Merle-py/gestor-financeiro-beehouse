{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/beeho/Desktop/painelFinanceiro/gestor-financeiro-beehouse/app/lib/supabase.js"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseKey)"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM;AACN,MAAM;AAEC,MAAM,WAAW,IAAA,yMAAY,EAAC,aAAa"}},
    {"offset": {"line": 53, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/beeho/Desktop/painelFinanceiro/gestor-financeiro-beehouse/app/api/cron/route.js"],"sourcesContent":["import { supabase } from '../../lib/supabase';\r\nimport { addMonths, setDate, format, lastDayOfMonth, getDate } from 'date-fns';\r\n\r\nexport const dynamic = 'force-dynamic'; // Garante que a fun√ß√£o rode sempre fresca\r\n\r\nexport async function GET(request) {\r\n  // Verifica√ß√£o de seguran√ßa (opcional, mas recomendado)\r\n  const authHeader = request.headers.get('authorization');\r\n  if (process.env.CRON_SECRET && authHeader !== `Bearer ${process.env.CRON_SECRET}`) {\r\n    // return new Response('Unauthorized', { status: 401 }); \r\n  }\r\n\r\n  try {\r\n    // 1. GERAR CONTAS RECORRENTES (M√™s Atual + Pr√≥ximo M√™s)\r\n    await gerarRecorrencias();\r\n\r\n    // 2. ENVIAR NOTIFICA√á√ïES (Seu c√≥digo original de notifica√ß√£o)\r\n    const notificationResult = await verificarVencimentos();\r\n\r\n    return Response.json({ success: true, notification: notificationResult });\r\n  } catch (error) {\r\n    return Response.json({ error: error.message }, { status: 500 });\r\n  }\r\n}\r\n\r\n// --- FUN√á√ÉO 1: GERA√á√ÉO AUTOM√ÅTICA DE CONTAS ---\r\nasync function gerarRecorrencias() {\r\n    const { data: recurring } = await supabase.from('recurring_expenses').select('*').eq('active', true);\r\n    if (!recurring || recurring.length === 0) return;\r\n\r\n    const hoje = new Date();\r\n    // Gera para o m√™s atual e para o pr√≥ximo m√™s (para previs√£o)\r\n    const mesesParaGerar = [hoje, addMonths(hoje, 1)]; \r\n    const novosLancamentos = [];\r\n\r\n    // Busca transa√ß√µes existentes nesses meses para evitar duplicidade\r\n    // (Uma otimiza√ß√£o seria filtrar por data no banco, mas faremos verifica√ß√£o em mem√≥ria para simplificar a l√≥gica de \"mesmo fornecedor/valor\")\r\n    const { data: transacoesExistentes } = await supabase.from('transactions').select('*');\r\n\r\n    for (const mesRef of mesesParaGerar) {\r\n        for (const item of recurring) {\r\n            // Calcula a data de vencimento correta\r\n            // Ex: Se o dia √© 31 e o m√™s s√≥ tem 30 dias, o date-fns/js ajustaria para dia 1 do outro m√™s.\r\n            // Vamos garantir que fique no √∫ltimo dia do m√™s correto.\r\n            let dataVencimento = setDate(mesRef, item.day_of_month);\r\n            \r\n            // Corre√ß√£o: Se o dia gerado mudou de m√™s (ex: era dia 31/02 -> virou mar√ßo), volta para o √∫ltimo dia do m√™s correto\r\n            if (dataVencimento.getMonth() !== mesRef.getMonth()) {\r\n                dataVencimento = lastDayOfMonth(mesRef);\r\n            }\r\n\r\n            const dataString = format(dataVencimento, 'yyyy-MM-dd');\r\n\r\n            // Verifica se j√° existe (Mesmo Fornecedor + Mesmo Valor + Mesma Data)\r\n            // Isso evita criar duplicado se o cron rodar v√°rias vezes\r\n            const jaExiste = transacoesExistentes.some(t => \r\n                t.supplier_id === item.supplier_id &&\r\n                // Compara valor como string ou n√∫mero (margem segura)\r\n                parseFloat(t.amount) === parseFloat(item.amount) && \r\n                t.due_date === dataString\r\n            );\r\n\r\n            if (!jaExiste) {\r\n                novosLancamentos.push({\r\n                    description: item.description,\r\n                    amount: item.amount,\r\n                    due_date: dataString,\r\n                    supplier_id: item.supplier_id,\r\n                    category_id: item.category_id,\r\n                    status: dataString < new Date().toISOString().split('T')[0] ? 'Vencido' : 'Aberto',\r\n                    // Adicionamos uma flag opcional para saber que veio da recorr√™ncia\r\n                    // recurring_source_id: item.id (se voc√™ quiser criar esse campo na tabela transactions depois)\r\n                });\r\n            }\r\n        }\r\n    }\r\n\r\n    if (novosLancamentos.length > 0) {\r\n        const { error } = await supabase.from('transactions').insert(novosLancamentos);\r\n        if (error) console.error('Erro ao gerar recorr√™ncias:', error);\r\n        else console.log(`Geradas ${novosLancamentos.length} novas contas recorrentes.`);\r\n    }\r\n}\r\n\r\n// --- FUN√á√ÉO 2: NOTIFICA√á√ïES (Sua l√≥gica original preservada e encapsulada) ---\r\nasync function verificarVencimentos() {\r\n    const hoje = new Date().toISOString().split('T')[0]; \r\n    const futuro = new Date();\r\n    futuro.setDate(futuro.getDate() + 2);\r\n    const dataFuturo = futuro.toISOString().split('T')[0];\r\n\r\n    const { data: contasHoje } = await supabase.from('transactions').select('*, suppliers(name)').eq('due_date', hoje).neq('status', 'Pago');\r\n    const { data: contasFuturo } = await supabase.from('transactions').select('*, suppliers(name)').eq('due_date', dataFuturo).neq('status', 'Pago');\r\n\r\n    if ((contasHoje && contasHoje.length > 0) || (contasFuturo && contasFuturo.length > 0)) {\r\n        await enviarParaBitrix(contasHoje || [], contasFuturo || []);\r\n        return 'Notifica√ß√£o enviada';\r\n    }\r\n    return 'Nada para notificar';\r\n}\r\n\r\nasync function enviarParaBitrix(hoje, futuro) {\r\n    const totalHoje = hoje.reduce((sum, i) => sum + i.amount, 0);\r\n    const totalFuturo = futuro.reduce((sum, i) => sum + i.amount, 0);\r\n    const quebra = \"\\n\";\r\n\r\n    let msg = \"üí∞ [B]FINANCEIRO BEEHOUSE[/B]\" + quebra;\r\n    msg += \"---------------------------------\" + quebra;\r\n\r\n    if(hoje.length > 0) {\r\n        msg += `üî¥ [B][COLOR=#ff0000]VENCE HOJE (${hoje.length})[/COLOR][/B] - Total: R$ ${totalHoje.toFixed(2)}` + quebra;\r\n        hoje.forEach(t => msg += `‚ñ™ ${t.description} - R$ ${t.amount}` + quebra);\r\n        msg += quebra;\r\n    }\r\n\r\n    if(futuro.length > 0) {\r\n        msg += `‚ö†Ô∏è [B]EM 2 DIAS (${futuro.length})[/B] - Total: R$ ${totalFuturo.toFixed(2)}` + quebra;\r\n        futuro.forEach(t => msg += `‚ñ™ ${t.description} - R$ ${t.amount}` + quebra);\r\n    }\r\n\r\n    msg += \"---------------------------------\" + quebra;\r\n    msg += `[URL=https://${process.env.VERCEL_URL}]‚û°Ô∏è ABRIR GESTOR[/URL]`;\r\n\r\n    const webhookUrl = process.env.BITRIX_WEBHOOK_URL + \"im.message.add\";\r\n    \r\n    await fetch(webhookUrl, {\r\n        method: 'POST',\r\n        headers: { 'Content-Type': 'application/json' },\r\n        body: JSON.stringify({\r\n            \"DIALOG_ID\": process.env.ID_COLABORADOR_FINANCEIRO,\r\n            \"MESSAGE\": msg,\r\n            \"SYSTEM\": \"Y\"\r\n        })\r\n    });\r\n}"],"names":[],"mappings":"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"}}]
}